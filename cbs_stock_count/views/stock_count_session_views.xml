<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Stock Count Session - Search View-->
    <record id="view_stock_count_session_search" model="ir.ui.view">
        <field name="name">stock.count.session.search</field>
        <field name="model">stock.count.session</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <filter string="Draft"
                        name="draft"
                        domain="[('state', '=', 'draft')]"/>
                <filter string="In-Progress"
                        name="in_progress"
                        domain="[('state', '=', 'in_progress')]"/>
                <filter string="Review"
                        name="review"
                        domain="[('state', '=', 'review')]"/>
                <filter string="Approval"
                        name="approval"
                        domain="[('state', '=', 'approval')]"/>
                <filter string="Done"
                        name="done"
                        domain="[('state', '=', 'done')]"/>
                <filter string="Rejected"
                        name="rejected"
                        domain="[('state', '=', 'rejected')]"/>
            </search>
        </field>
    </record>

    <!-- Stock Count Session - List View -->
    <record id="view_stock_count_session_list" model="ir.ui.view">
        <field name="name">stock.count.session.list</field>
        <field name="model">stock.count.session</field>
        <field name="arch" type="xml">
            <list>
                <field name="name"/>
                <field name="state"/>
                <field name="user_id"/>
                <field name="attendee_ids" widget="many2many_tags"/>
                <field name="warehouse_id"/>
                <field name="location_id"/>
                <field name="line_count"/>
                <field name="qty_counted_total"/>
                <field name="qty_difference_total"/>
                <field name="count_effective_date"/>
                <field name="date_end"/>
            </list>
        </field>
    </record>

    <!-- Stock Count Session - Form View-->
    <record id="view_stock_count_session_form" model="ir.ui.view">
        <field name="name">stock.count.session.form</field>
        <field name="model">stock.count.session</field>
        <field name="arch" type="xml">
            <form string="Stock Count Session">
                <header>
                    <field name="is_finance_manager" invisible="1"/>

                    <button name="action_generate_lines"
                            string="Generate Lines"
                            type="object"
                            class="oe_highlight"
                            invisible="state != 'draft'"/>

                    <button name="action_submit_count"
                            string="Submit Count"
                            type="object"
                            class="oe_highlight"
                            invisible="state != 'in_progress'"/>

                    <button name="action_validate"
                            string="Validate"
                            type="object"
                            class="oe_highlight"
                            invisible="state != 'review'"/>

                    <button name="action_approved"
                            string="Approve"
                            type="object"
                            class="oe_highlight"
                            invisible="state != 'approval'"
                            groups="base.group_finance_manager,base.group_system"/>

                    <button name="action_refuse_recount"
                            string="Refuse for Recount"
                            type="object"
                            class="btn-warning"
                            invisible="state != 'approval'"
                            groups="base.group_finance_manager,base.group_system"/>

                    <button name="action_rejected"
                            string="Reject"
                            type="object"
                            class="btn-secondary"
                            invisible="state != 'approval'"
                            groups="base.group_finance_manager,base.group_system"/>

                    <field name="state"
                           widget="statusbar"
                           statusbar_visible="draft,in_progress,review,approval,done,rejected"/>
                </header>

                <sheet>
                    <!-- Title -->
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>

                    <!-- Main Information -->
                    <group>
                        <group>
                            <field name="user_id"/>
                            <field name="finance_manager_id"
                                   domain="[('groups_id', 'in', [%(base.group_finance_manager)d])]"/>
                            <field name="attendee_ids" widget="many2many_tags"/>
                            <field name="stock_filter"/>
                            <field name="warehouse_id"/>
                            <field name="location_id"/>
                            <field name="count_effective_date"/>
                            <field name="date_start"/>
                            <field name="date_end"/>
                        </group>
                        <group>
                            <field name="line_count" readonly="1"/>
                            <field name="qty_counted_total" readonly="1"/>
                            <field name="qty_difference_total"
                                string="Total Qty Difference"
                                readonly="1"
                                invisible="state not in ('approval', 'done', 'rejected')"/>
                            <field name="review_date" readonly="1"/>
                            <field name="approval_date" readonly="1"/>
                            <field name="rejection_date" readonly="1"/>
                            <field name="rejection_reason"
                                   readonly="1"
                                   invisible="not rejection_date"/>
                        </group>
                    </group>

                    <!-- Calculated Outcomes (Finance Manager Only) -->
                    <group string="Calculated Outcomes"
                           col="3"
                           invisible="not is_finance_manager and not context.get('uid') == 1"
                           groups="base.group_finance_manager,base.group_system">
                        <group string="Quantity Differences">
                            <field name="total_diff_qty_positive" readonly="1"/>
                            <field name="total_diff_qty_negative" readonly="1"/>
                        </group>
                        <group string="Value Differences">
                            <field name="total_diff_value_positive" readonly="1"/>
                            <field name="total_diff_value_negative" readonly="1"/>
                            <field name="total_diff_value_net" readonly="1"/>
                        </group>
                        <group string="Review Value Differences">
                            <field name="total_diff_review_value_positive" readonly="1"/>
                            <field name="total_diff_review_value_negative" readonly="1"/>
                            <field name="total_diff_review_value_net" readonly="1"/>
                        </group>
                    </group>

                    <!-- Notebook Pages -->
                    <notebook>
                        <!-- Count Lines Page -->
                        <page string="Count Lines">
                            <field name="line_ids"
                                   readonly="state in ('done', 'rejected')"
                                   context="{'default_session_id': id, 'default_location_id': location_id}">
                                <list editable="bottom"
                                      decoration-danger="qty_difference != 0 and parent.state not in ('draft', 'in_progress')">
                                    <field name="product_id" readonly="1" force_save="1"/>
                                    <field name="product_category_id" optional="show" readonly="1"/>
                                    <field name="location_id" optional="show"/>
                                    <field name="barcode_scanned" column_invisible="True"/>
                                    <field name="lot_id" optional="show"/>
                                    <field name="package_id" optional="hide"/>
                                    <field name="uom_id" readonly="1"/>

                                    <field name="qty_system"
                                           readonly="1"
                                           force_save="1"
                                           column_invisible="parent.state not in ('approval', 'done', 'rejected')"/>

                                    <field name="qty_counted"
                                           readonly="parent.state not in ('draft', 'in_progress')"/>

                                    <field name="qty_review_counted"
                                           readonly="parent.state not in ('review', 'approval')"
                                           column_invisible="parent.state in ('draft', 'in_progress')"/>

                                    <field name="qty_difference"
                                           readonly="1"
                                           column_invisible="parent.state not in ('approval', 'done', 'rejected')"/>

                                    <field name="product_value_before"
                                           readonly="1"
                                           optional="hide"
                                           column_invisible="parent.state not in ('approval', 'done', 'rejected')"/>

                                    <field name="count_net_difference_value"
                                           readonly="1"
                                           optional="show"
                                           column_invisible="parent.state not in ('approval', 'done', 'rejected')"/>

                                    <field name="variant_percentage_value"
                                           readonly="1"
                                           optional="show"
                                           column_invisible="parent.state not in ('approval', 'done', 'rejected')"/>

                                    <field name="accepted_product_diff_kpi"
                                           readonly="1"
                                           optional="show"
                                           column_invisible="parent.state not in ('approval', 'done', 'rejected')"/>

                                    <field name="scanned_by" readonly="1" optional="hide"/>
                                    <field name="scanned_at" readonly="1" optional="hide"/>
                                    <field name="note" optional="show"/>
                                </list>
                            </field>
                        </page>

                        <!-- Summary Page - Products with Difference -->
                        <page string="Summary - Products with Difference">
                            <field name="line_ids"
                                   readonly="1"
                                   domain="[('qty_difference', '!=', 0)]"
                                   context="{'default_session_id': id}">
                                <list>
                                    <field name="product_id"/>
                                    <field name="product_category_id"/>
                                    <field name="location_id" optional="show"/>
                                    <field name="qty_system"/>
                                    <field name="qty_counted"/>
                                    <field name="qty_review_counted"/>
                                    <field name="qty_difference"/>
                                    <field name="product_value_before"/>
                                    <field name="count_net_difference_value"/>
                                    <field name="variant_percentage_value"/>
                                    <field name="accepted_product_diff_kpi"/>
                                </list>
                            </field>
                        </page>

                        <!-- Notes Page -->
                        <page string="Notes">
                            <field name="note" nolabel="1"/>
                        </page>
                    </notebook>
                </sheet>

                <chatter/>
            </form>
        </field>
    </record>

    <!-- Stock Count Session - Window Action-->
    <record id="action_stock_count_session" model="ir.actions.act_window">
        <field name="name">Count Sessions</field>
        <field name="res_model">stock.count.session</field>
        <field name="view_mode">list,form</field>
    </record>

</odoo>
